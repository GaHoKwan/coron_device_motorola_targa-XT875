#!/system/bin/sh

function killSystemProc(){
	ps | grep "/system" | busybox awk '{print $2}' | busybox xargs kill -9
}

function useBaiduAdbd(){
	setprop persist.sys.usb.config none
	rm /sbin/adbd
	busybox cp -r /system/sbin/adbd /sbin/
	chmod 0750 /sbin/adbd
	ls -l /sbin
	ps | grep adb | busybox awk '{print $2}' | busybox xargs kill -9
	setprop persist.sys.usb.config adb
	echo "use baidu's adbd done!"
}

function setAdbReady(){
	setprop persist.adb.ready 1
}

function resetSuPermission(){
	ls -l /system/xbin/su
	echo "set su permission to 6755"
	chown root:root /system/xbin/su
	chmod 6755 /system/xbin/su
	ls -l /system/xbin/su
}

function startBaiduService(){
	echo "start baidu's services"
	/system/bin/serviceext &
	/system/bin/WordSegService &
}

# append install-recovery.sh to start other service
curLog="/data/local/tmp/current_bdrec_log"
lastLog="/data/local/tmp/last_bdrec_log"
if [ -f $curLog ]; then
mv $curLog $lastLog
fi
date > $curLog
chmod 777 $curLog
{
echo "remount system with rw"
stop
cat /dev/input/event5 > /dev/keycheck &
sleep 3
kill -9 $!
mount -o remount,rw rootfs /
mount -o remount,rw /system
start
resetSuPermission
useBaiduAdbd
setAdbReady
startBaiduService
mount -o remount,ro rootfs /
mount -o remount,ro /system
} 2>&1 > $curLog
